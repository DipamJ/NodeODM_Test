<?php 
	
	require_once("Resources/PHP/SetDBConnection.php");

	$con = SetDBConnection();
	
	if(mysqli_connect_errno($con))
	{
		echo "Failed to connect to database server: ".mysqli_connect_error();
	}
	else
	{
		session_start();
		$userName = $_SESSION["username"];
		$roles = $_SESSION["userroles"];
		$groups = $_SESSION["groups"];
		unset($_SESSION["page"]);
	
		if (!$roles){
			$_SESSION["page"] =  "http://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";
			header("Location: http://basfhub.gdslab.org/");
			exit();
		} else  {
			$pageName = basename(__DIR__);
			if ($pageName == "V2"){
				$pageName = basename(realpath(__DIR__ . "/.."));
			}
			
			$sql = "SELECT * FROM page_access WHERE Page = '$pageName'";
			$allowedGroups = array();
			if ($result = mysqli_query($con,$sql)){
				if ($row = mysqli_fetch_assoc($result)){
					$allowedGroups = explode(";", $row["Groups"]);
					$accessGroupsStr = $row["Groups"];
				}
			}
			
			$intersect = array_intersect($groups,$allowedGroups);
			if (sizeof($intersect) > 0){
				
		
?>	
			<!DOCTYPE>
				<html lang="html">

					<head>
						<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
						<title>UAS Data Admin</title>
						
						<link rel="stylesheet" type="text/css" href="Resources/style.css">
						<script src="Resources/JS/jquery.min.js" type="text/javascript"></script>
						<script src="Resources/JS/main.js" type="text/javascript"></script>
						<script src="Resources/JS/Chosen/chosen.jquery.min.js"></script>
						<link rel="stylesheet" type="text/css" href="Resources/JS/Chosen/chosen.css">
						<script src="Resources/JS/JqueryUI/jquery-ui.min.js"></script>
						<link rel="stylesheet" type="text/css" href="Resources/JS/JqueryUI/jquery-ui.css">
						
						<script src="Resources/JS/FixedTable/fixed_table_rc.js"></script>
						<link rel="stylesheet" type="text/css" href="Resources/JS/FixedTable/fixed_table_rc.css">
						
						<script src="Resources/JS/jquery.alphanum.js"></script>
						
						<style>
							.add-button{
								float:right;
								margin: 10px 0 0 0;
							}
							
							.ft_container{
								margin: 0 auto;
								z-index: 1;
							}
							
							.ft_rel_container{
								z-index: 1;
							}
							
							
						</style>
						
					</head>

					
					
					<body>
						<div id="loading"></div>
						<form id='manage'>
							<h2>UAS Data Admin</h2>
							<br>
							<div style="clear:both"></div>
							
							
							<div id="tabs">
								<ul>
									<li><a href="#project">Project</a></li>
									<li><a href="#crop">Crop</a></li>
									<li><a href="#platform">Platform</a></li>
									<li><a href="#sensor">Sensor</a></li>
									<li><a href="#flight">Flight</a></li>
									<li><a href="#product-type">Product Type</a></li>
									<li><a href="#raw-data">Raw Data</a></li>
									<li><a href="#data-product">Data Product</a></li>
								</ul>
								<div id="project">
									<fieldset>
										<legend>Add Project</legend>
										
										<div class ="half-width">
											<div class="label">Name</div>
											<div class="input"><input type="text" id="project-name"  class="large"></div>
											<div style="clear:both"></div>
											<div class="label">Crop</div>
											<select id="crop-type" class="select-large"></select>
										</div>
										
										<div class ="half-width">
											<div class="label">Planting Date</div>
											<div class="input"><input type="text" id="planting-date" class="normal"></div>
											<div style="clear:both"></div>
											<div class="label">Harvest Date</div>
											<div class="input"><input type="text" id="harvest-date" class="normal"></div>
										</div>
										
										<div style="clear:both"></div>
										
										<div class ="full-width">
											<div class="label">Description</div>
											<div class="input" style="width: 80%"><textarea rows="4" cols="75" style="width: 100%" maxlength="3000" id="description" ></textarea></div>
										</div>
										
										<div style="clear:both"></div>
										
										<div class ="half-width">
											<div class="label">Center Lat</div>
											<div class="input"><input type="text" id="center-lat" class="coordinate normal" value='27.78230'></div>
										</div>
										
										<div class ="half-width">
											<div class="label">Center Long</div>
											<div class="input"><input type="text" id="center-lng" class="coordinate normal" value='-97.56060' ></div>
										</div>
										
										<div style="clear:both"></div>
										
										<div class ="one-third-width">
											<div class="label">Min Zoom</div>
											<div class="input"><input type="text" class="small zoom" id="min-zoom" value="17"></div>
										</div>
										
										<div class ="one-third-width">
											<div class="label">Max Zoom</div>
											<div class="input"><input type="text" class="small zoom" id="max-zoom" value="25"></div>
										</div>
										
										<div class ="one-third-width">
											<div class="label">Default Zoom</div>
											<div class="input"><input type="text" class="small zoom" id="default-zoom" value="19"></div>
										</div>
										
										<div style="clear:both"></div>
										
										<div class ="full-width">
											<div class="label">Visualization Page</div>
											<div class="input"><textarea rows="2" cols="75" style="width: 100%" maxlength="3000" id="visualization" ></textarea></div>
										</div>
										
									</fieldset>
									
									<div style="clear:both; margin: 5px"></div>
								
									<input id="add-project" class="add-button" type="button" value="Add" onclick="Add('project'); return false;"/>
							
									<div style="clear:both"></div>
										
									<fieldset>
										<legend>Project List</legend>
										<div>
											<div class="label">Filter (Name)</div>
											<div class="input"><input id="project-search" type="text" ></div>
										</div>
										<div style="clear:both; margin: 5px"></div>
										<br>
										<div id="project-wrapper"></div>
									</fieldset>
								</div>
								<div id="platform">
									<fieldset>
										<legend>Add Platform</legend>
										<div style="width:400px; margin: 0 auto;">
											<div class="label">Name</div>
											<div class="input"><input type="text" id="platform-name"></div>
										</div>
									</fieldset>
									
									<div style="clear:both; margin: 5px"></div>
								
									<input id="add-platform" class="add-button"  type="button" value="Add" onclick="Add('platform'); return false;"/>
							
									<div style="clear:both"></div>
										
									<fieldset>
										<legend>Platform List</legend>
										<div id="platform-wrapper"></div>
									</fieldset>
								</div>
								<div id="sensor">
									<fieldset>
										<legend>Add Sensor</legend>
										<div style="width:400px; margin: 0 auto;">
											<div class="label">Name</div>
											<div class="input"><input type="text" id="sensor-name"></div>
										</div>
									</fieldset>
									
									<div style="clear:both; margin: 5px"></div>
								
									<input id="add-sensor" class="add-button"  type="button" value="Add" onclick="Add('sensor'); return false;"/>
							
									<div style="clear:both"></div>
										
									<fieldset>
										<legend>Sensor List</legend>
										<div id="sensor-wrapper"></div>
									</fieldset>
								</div>
								<div id="flight">
									<fieldset >
										<legend>Search</legend>
										<div>
											<div class="label">Project</div>
											<select id="flight-project"  class="select-large">
											</select>
										</div>
										
										
										<div>
											<div class="label">Platform</div>
											<select id="flight-platform">
											</select>
										</div>
										
										
										<div>
											<div class="label">Sensor</div>
											<select id="flight-sensor">
											</select>
										</div>
									</fieldset>
									
									<div style="clear:both; margin: 5px"></div>
									<input id="search-flight" class="add-button"  type="button" value="Search" onclick="GetList('flight'); return false;"/>
									<div style="clear:both"></div>
									
									<fieldset>
										<legend>Add Flight</legend>
											<div>
												<div class="label">Name</div>
												<div class="input"><input type="text" id="flight-name"></div>
											</div>
											
											<!--
											<div>
												<div class="label">Project</div>
												<select id="flight-project"  class="select-large">
												</select>
											</div>
											
											<div style="clear:both"></div>
											
											<div>
												<div class="label">Platform</div>
												<select id="flight-platform">
												</select>
											</div>
											
											<div style="clear:both"></div>
											
											<div>
												<div class="label">Sensor</div>
												<select id="flight-sensor">
												</select>
											</div>
										-->
										
											<div>
												<div class="label">Date</div>
												<div class="input"><input type="text" id="flight-date" class="small"></div>
											</div>
											
											
											<div>
												<div class="label">Flight Altitude</div>
												<div class="input"><input type="text" id="flight-altitude" class="tiny"></div>
											</div>
											
											
											<div>
												<div class="label">Forward Overlap</div>
												<div class="input"><input type="text" id="flight-forward" class="tiny"></div>
											</div>
											
											
											<div>
												<div class="label">Side Overlap</div>
												<div class="input"><input type="text" id="flight-side" class="tiny"></div>
												<div style="clear:both"></div>
											</div>
									</fieldset>
									
									<div style="clear:both; margin: 5px"></div>
									
								
									<input id="add-flight" class="add-button"  type="button" value="Add" onclick="Add('flight'); return false;"/>
							
									<div style="clear:both"></div>
										
									<fieldset>
										<legend>Flight List</legend>
										<div id="flight-wrapper"></div>
									</fieldset>
									
								</div>
								
								
								<div id="product-type">
									<fieldset>
										<legend>Add Product Type</legend>
										<div style="width:400px; margin: 0 auto;">
											<div class="label">Name</div>
											<div class="input"><input type="text" id="type-name"></div>
										</div>
									</fieldset>
									
									<div style="clear:both; margin: 5px"></div>
								
									<input id="add-sensor" class="add-button"  type="button" value="Add" onclick="Add('type'); return false;"/>
							
									<div style="clear:both"></div>
										
									<fieldset>
										<legend>Product Type List</legend>
										<div id="type-wrapper"></div>
									</fieldset>
								</div>
								
								<div id="crop">
									<fieldset>
										<legend>Add Crop</legend>
										<div style="width:400px; margin: 0 auto;">
											<div class="label">Name</div>
											<div class="input"><input type="text" id="crop-name"></div>
										</div>
									</fieldset>
									
									<div style="clear:both; margin: 5px"></div>
								
									<input id="add-crop" class="add-button"  type="button" value="Add" onclick="Add('crop'); return false;"/>
							
									<div style="clear:both"></div>
										
									<fieldset>
										<legend>Crop List</legend>
										<div id="crop-wrapper"></div>
									</fieldset>
								</div>
								<div id="raw-data">
									<fieldset >
										<legend>Search</legend>
										<div>
											<div class="label">Project</div>
											<select id="raw-data-project" class="select-large">
											</select>
										</div>
										<div>
											<div class="label">Platform</div>
											<select id="raw-data-platform">
											</select>
										</div>
										
										
										<div>
											<div class="label">Sensor</div>
											<select id="raw-data-sensor">
											</select>
										</div>
										
									</fieldset>
									
									<div style="clear:both; margin: 5px"></div>
									<input type="button" class="add-button"  value="Search" onclick="Search('raw'); return false;"/>
									<div style="clear:both"></div>
									
									<fieldset >
										<legend>Unfinished List</legend>
										<div id="unfinished-raw-list-wrapper" style="text-align:center;"></div>
									</fieldset>
									<div style="clear:both"></div>
									<br>
									<fieldset >
										<legend>Finished List</legend>
										<div id="finished-raw-list-wrapper"></div>
									</fieldset>
									<div style="clear:both"></div>
								</div>
								<div id="data-product">
									<fieldset >
										<legend>Search</legend>
										<div>
											<div class="label">Project</div>
											<select id="data-product-project" class="select-large">
											</select>
										</div>
										<div style="clear:both"></div>
										<div>
											<div class="label">Platform</div>
											<select id="data-product-platform">
											</select>
										</div>
										
										
										<div>
											<div class="label">Sensor</div>
											<select id="data-product-sensor">
											</select>
										</div>	
										
										<div>
											<div class="label">Type</div>
											<select id="data-product-type">
											</select>
										</div>	
									</fieldset>
									
									<div style="clear:both; margin: 5px"></div>
									<input type="button" class="add-button"  value="Search" onclick="Search('product'); return false;"/>
									<div style="clear:both"></div>
									
									
									<fieldset >
										<legend>Unfinished List</legend>
										<div id="unfinished-product-list-wrapper" style="text-align:center;"></div>
									</fieldset>
									<div style="clear:both"></div>
									<br>
									<fieldset >
										<legend>Finished List</legend>
										<div id="finished-product-list-wrapper"></div>
									</fieldset>
									<div style="clear:both"></div>
									<br>
									
									<div id="dialog-tms" title="TMS Path" style="display:none">
										<textarea id="tms-path" rows="3" cols="50" readonly></textarea>
										<div style="text-align:center">
											<input type="button" class="button" value="Copy TMS" onclick="CopyToClipBoard('tms'); return false;"/>
											<input type="button" class="button" value="Preview" onclick="Preview(); return false;"/>
										</div>
									</div>
									<div id="dialog-download" title="Download Link / Local Path" style="display:none">
										<p>Download Link</p>
										<textarea id="download-link" rows="3" cols="50" readonly></textarea>
										<div style="text-align:center">
											<input type="button" class="button" value="Copy Link" onclick="CopyToClipBoard('link'); return false;"/>
											<input type="button" class="button" value="Download" onclick="Download(); return false;"/>
										</div>
										<hr>
										<p>Local Path</p>
										<textarea id="local-path" rows="3" cols="50" readonly></textarea>
										<div style="text-align:center">
											<input type="button" class="button" value="Copy Path" onclick="CopyToClipBoard('path'); return false;"/>
										</div>
									</div>
								</div>
							</div>
								
							
								
						</form>
					</body>
				</html>
<?php

			} else {
				$memberOf = (implode("; ", $groups));
			
?>
				<!DOCTYPE>
				<html lang="html">
				<head>
					<title><?php echo $page; ?></title>
				</head>
				<body>
					<p>Hello, <?php echo $userName; ?>!</p>
					<p>You do not currently have permission to access this page</p>
					<p>Please contact admin at <a href="mailto:long.huynh@tamucc.edu">long.huynh@tamucc.edu</a></p>
				</body>
				</html>
				
<?php
			}
		}
		
	}
?>							
